Airflow развернут в Docker контейнере по <a href="https://medium.com/@technologIT/apache-airflow-%D1%87%D0%B0%D1%81%D1%82%D1%8C-4-%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-9fa5cb9d0e06">инструкции</a> (с учетом установки обновленной версии airflow 2.4.1)

Для запуска контейнера необходимо выполнить последовательно следующие команды:
- Создание образа с помощью Docker файла
```bash
docker build -t airflow-basic .
```
Наш созданный образ будет называться **airflow-basic**
- Запуск Docker контейнера
```bash
docker run --rm --mount src="C:\Users\alpex\HSE_study\Git\ds\Airflow_example\dags",dst="//usr/local/airflow/dags",type=bind -d -p 8080:8080 airflow-basic
```

```--rm``` означает, что как только контейнер будет остановлен, он будет автоматически удален

```--mount``` означает, что мы привязываем папку в контейнере к папке на локальном компьютере и все изменения в одной из этих папок автоматически будут отображены в другой

- Для доступа к терминалу контейнера необходимо ввести
```bash
docker exec -it CONTAINER_ID /bin/bash
```
CONTAINER_ID можно посмотреть с помощью команды
```bash
docker ps
```
Данная команда выдаст нечто подобное:
```bash
CONTAINER ID   IMAGE           COMMAND            CREATED          STATUS          PORTS                    NAMES
598b12a402be   airflow-basic   "/entrypoint.sh"   21 seconds ago   Up 20 seconds   0.0.0.0:8080->8080/tcp   determined_beaver
```
где CONTAINER_ID - 598b12a402be
- Теперь можно перейти в браузере по адресу http://localhost:8080

Для выхода из терминала необходимо нажать ```CTRL+D```.
Основные команды из туториала представлены в папке docs

### Возникшие проблемы при разворачивании контейнера и их решение

#### Docker не мог "достучаться" до БД Postgres на localhost

Узнать IP local хоста на Windows можно с помощью команды ipconfig в PowerShell. Получим такой вывод:

```shell script
Wireless LAN adapter Беспроводная сеть:

   Connection-specific DNS Suffix  . :
   Link-local IPv6 Address . . . . . : fe80::895:7eff:8c6d:86ab%14
   IPv4 Address. . . . . . . . . . . : 192.168.1.75
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : fe80::1%14
                                       192.168.1.1
```
```IPv4 Address``` и есть IP local хоста. В нашем случае это ```192.168.1.75```.

Для того, чтобы узнать IP контейнера, необходимо в bash контейнера ввести ```hostname -i```. Получим к примеру такой вывод:

```
172.17.0.2
```

Конфигурационные файлы Postgres находятся в папке (в моем случае) ```C:\Program Files\PostgreSQL\13\data```. Нас интересуют два файла:
- postgresql.conf

В этом файле указаны listen_addresses (host) и port, задающие точку подключения к Postgres:

```text
#------------------------------------------------------------------------------
# CONNECTIONS AND AUTHENTICATION
#------------------------------------------------------------------------------

# - Connection Settings -

listen_addresses = '*'      # what IP address(es) to listen on;
                            # comma-separated list of addresses;
                            # defaults to 'localhost'; use '*' for all
                            # (change requires restart)
port = 5432                 # (change requires restart)
```

`listen_addresses` - задаёт адреса TCP/IP, по которым сервер будет принимать подключения клиентских приложений. 
Это значение принимает форму списка, разделённого запятыми, из имён и/или числовых IP-адресов компьютеров. 
Особый элемент, *, обозначает все имеющиеся IP-интерфейсы. Запись 0.0.0.0 позволяет задействовать все адреса IPv4, 
а :: — все адреса IPv6. Если список пуст, сервер не будет привязываться ни к какому IP-интерфейсу, а значит, 
подключиться к нему можно будет только через Unix-сокеты. По умолчанию этот параметр содержит localhost, что допускает 
подключение к серверу по TCP/IP только через локальный интерфейс «замыкания».

`port` - TCP-порт, открываемый сервером; по умолчанию, 5432. Заметьте, что этот порт используется для всех IP-адресов, 
через которые сервер принимает подключения. Этот параметр можно задать только при запуске сервера.

- pg_hba.conf

Этот файл определяет: каким хостам разрешено подключаться, как аутентифицируются клиенты, какие имена пользователей 
PostgreSQL они могут использовать, к каким базам данных они могут получить доступ. 
Записи принимают одну из следующих форм:

```text
# local         DATABASE  USER           METHOD  [OPTIONS]
# host          DATABASE  USER  ADDRESS  METHOD  [OPTIONS]
# hostssl       DATABASE  USER  ADDRESS  METHOD  [OPTIONS]
# hostnossl     DATABASE  USER  ADDRESS  METHOD  [OPTIONS]
# hostgssenc    DATABASE  USER  ADDRESS  METHOD  [OPTIONS]
# hostnogssenc  DATABASE  USER  ADDRESS  METHOD  [OPTIONS]
```

После внесения изменений в эти два файла необходимо перезапустить сервер Postgres. Для решения этой задачи в Windows можно 
воспользоваться Services:
- нажимаем `Windows + R`
- вводим `services.msc` и нажимаем Enter. Откроется окно Services.
- находим Postgres и через правую кнопку мыши нажимаем `Restart`

Теперь необходимо проверить, можем ли мы "достучаться" до local хоста из нашего контейнера:
- `ping 192.168.1.75` - доступен ли IP из докера
- `telnet 192.168.1.75 5432` - доступен ли IP port из докера

Если мы не можем подсоединиться до local хоста, то необходимо внести изменения в конфигурационные файлы postgres (см. выше). 
А именно внести следующие изменения:
- в `postgresql.conf` в значении переменной `listen_addresses` указать `'*'` (все IP интерфейсы), либо `'0.0.0.0'` 
(все IPv4 интерфейсы), либо указать определенный IP адрес, на который мы будем "стучаться" из docker контейнера.
- в `pg_hba.conf` необходимо указать каким хостам возможно подключаться с какими параметрами аутентификации. 
В общем случае необходимо добавить следующие строки в файл:

```
host        all         all         0.0.0.0/0           md5
host        all         all         ::/0                md5
```

Это значит со всех адресов IPv4 и IPv6 возможно подключение ко всем базам под всеми пользователями (что конечно же не есть хорошо).
Поэтому можно указать роли и базы более конкретно.

```
host        titanic         postgres         0.0.0.0/0           md5
```

Аналогично можно поступить и с указанием адреса.

#### docker run выдает ошибку `bash\r: No such file or directory`

В данном случае проблема связана с тем, что в данной кодировке строка в файле `entrypoint.sh` заканчивается символом окончания строки `\r`.
В Unix системах символ окончания строки - `\n`. Для того, чтобы это поправить, необходимо открыть файл в PyCharm и в правом нижнем углу 
поменять line separator на LF.